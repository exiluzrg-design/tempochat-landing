<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tarot IA â€” Secuencia OK + Chat Ajustado (Fix)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Marcellus&display=swap" rel="stylesheet">
  <style>
    html, body{
      height:100%; margin:0;
      background: radial-gradient(2000px 1400px at 50% 45%, #5f3bb8 0%, #3b1a77 45%, #1a083a 100%);
      color:#fff; overflow:hidden; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .screen{min-height:100vh; width:100vw; display:flex; align-items:center; justify-content:center;}
    .stage{width:100vw; height:100vh; position:relative; overflow:hidden; background:transparent;}

    :root{ --card-w:128px; --card-h:204px; }
    .card{
      position:absolute; width:var(--card-w); height:var(--card-h);
      border-radius:14px; overflow:hidden;
      border:1px solid rgba(231,195,114,.35);
      box-shadow:0 10px 25px rgba(0,0,0,.5), inset 0 0 0 1px #6d4ad140;
      transform-origin:50% 85%;
      opacity:0; transform:translateY(110vh) rotate(0deg);
      transition: transform 1.6s cubic-bezier(.2,.8,.2,1), opacity 1.6s cubic-bezier(.2,.8,.2,1), filter .5s ease;
      will-change: transform, opacity, filter;
    }
    .card.show{ opacity:1; }
    .card.show::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(115deg, transparent 35%, rgba(255,255,255,.28) 50%, transparent 65%);
      transform: translateX(-120%);
      animation: sheen 5s ease-in-out 1;
      mix-blend-mode: screen; pointer-events:none;
    }
    @keyframes sheen{ 0%{transform:translateX(-120%);} 100%{transform:translateX(120%);} }

    .card svg{ position:absolute; inset:0; width:100%; height:100%; display:block; }

    @media (max-width:920px){ :root{ --card-w:110px; --card-h:192px; } }
    @media (max-width:640px){ :root{ --card-w:104px; --card-h:182px; } }

    /* Ventana de bienvenida */
    .soft-dialog{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(800px, 90vw); padding:32px 36px;
      background:transparent; border:none; box-shadow:none;
      color:#f5ecff; text-align:center; z-index:20;
      font-family:'Marcellus', Georgia, 'Times New Roman', serif;
      font-size:clamp(26px,3vw,40px); line-height:1.5; opacity:0;
      letter-spacing:.2px;
    }
    .soft-dialog .text{ margin-top:14px; font-family:'Inter', sans-serif; font-size:clamp(18px, 2.2vw, 22px); opacity:.95; }
    @keyframes dialogFadeIn { 0%{opacity:0; transform:translate(-50%,-52%);} 100%{opacity:1; transform:translate(-50%,-50%);} }
    @keyframes dialogFadeOut { 0%{opacity:1; transform:translate(-50%,-50%) scale(1);} 100%{opacity:0; transform:translate(-50%,-52%) scale(.98);} }
    .stage.show-dialog .soft-dialog{ animation: dialogFadeIn 1.8s ease forwards; }
    .soft-dialog.fade-out{ animation: dialogFadeOut .6s ease forwards; }

    /* Blur cartas cuando hay ventana o chat */
    .stage.show-dialog .card,
    .stage.show-chat .card{ filter: blur(2px) brightness(.86); }

    /* Chat */
    .chat-wrap{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(520px, 46vw);
      z-index:22; opacity:0;
      animation: chatIn .8s ease forwards;
      font-family:'Inter', sans-serif;
    }
    @media (max-width:920px){ .chat-wrap{ width:min(720px, 78vw); } }
    @media (max-width:640px){
      .chat-wrap{ width:96vw; }
      .chat-pane{ padding:22px; }
      .messages{ max-height:min(64vh, 560px); font-size:18px; }
      .input-row{ grid-template-columns: 1fr; gap:10px; }
      .input-row button{ width:100%; height:56px; font-size:18px; }
      .input-row textarea{ height:88px; font-size:18px; }
    }

    @keyframes chatIn { 0%{opacity:0; transform:translate(-50%,-52%);} 100%{opacity:1; transform:translate(-50%,-50%);} }
    .chat-pane{
      background: radial-gradient(120% 160% at 50% 0%, rgba(44,21,93,.4) 0%, rgba(22,10,48,.32) 60%, rgba(12,5,28,.26) 100%);
      border:1px solid rgba(231,195,114,.35);
      border-radius:16px; padding:16px;
      box-sizing: border-box;
    }
    .messages, .input-row{ width:100%; box-sizing:border-box; }

    .messages{
      max-height:min(40vh, 320px);
      overflow:auto;
      padding:8px 6px;
      display:flex; flex-direction:column; gap:10px;
      font-size:clamp(16px, 1.8vw, 20px);
    }
    .bubble{
      background: rgba(24,10,52,.55);
      border:1px solid rgba(231,195,114,.28);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.45;
    }
    .bubble.bot{ align-self:flex-start; }
    .bubble.user{ align-self:flex-end; background: rgba(109,74,209,.35); }

    .input-row{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px; align-items:center;
    }
    .input-row textarea{
      width:100%; resize:none; height:56px;
      background: rgba(12,5,28,.5); color:#f5ecff;
      border:1px solid rgba(231,195,114,.28);
      border-radius:12px; padding:12px 14px;
      font-size:16px; outline:none; box-sizing:border-box;
      font-family:'Inter', sans-serif;
    }
    .input-row button{
      height:56px; padding:0 18px; border-radius:12px; border:1px solid rgba(231,195,114,.45);
      background: rgba(231,195,114,.14); color:#f9f0ff; font-weight:600;
      cursor:pointer; transition: transform .15s ease, background .2s ease;
      font-family:'Inter', sans-serif;
    }
    .input-row button:hover{ transform: translateY(-1px); background: rgba(231,195,114,.20); }
  </style>
</head>
<body>
  <div class="screen"><div id="root"></div></div>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    const Back = () => (
      <svg viewBox="0 0 100 160" aria-hidden>
        <defs>
          <radialGradient id="g" cx="50%" cy="20%" r="80%">
            <stop offset="0%" stopColor="#3a1e73"/><stop offset="65%" stopColor="#2a105a"/><stop offset="100%" stopColor="#160a34"/>
          </radialGradient>
        </defs>
        <rect x="0" y="0" width="100" height="160" rx="10" fill="url(#g)"/>
      </svg>
    );

    const CardBack = () => (
      <div className="absolute inset-0 rounded-xl overflow-hidden" style={{border:'1px solid #e7c37255'}}>
        <Back/>
      </div>
    );

    const useWindowSize = () => {
      const [s,setS]=React.useState({w: innerWidth, h: innerHeight});
      React.useEffect(()=>{ const f=()=> setS({w: innerWidth, h: innerHeight}); addEventListener('resize', f); return ()=> removeEventListener('resize', f); },[]);
      return s;
    };
    const deg = r => r * 180 / Math.PI;

    function computeFanLayout(stageW, stageH, cardW, cardH, total=22, bp='desktop'){
      const padX = Math.max(6, cardW*0.08);
      const padTop = Math.max(8, cardH*0.18);
      const padBottom = Math.max(12, cardH*0.22);
      const cx = stageW / 2;
      const spanDeg = bp==='mobile'?120 : bp==='tablet'?150 : 180;
      const span = spanDeg * Math.PI/180;
      const phiCenter = 3*Math.PI/2;
      const N = bp==='mobile' ? 9 : total;
      const rMaxW = (stageW/2) - padX - cardW/2;
      const rMaxH = ((stageH - padTop - padBottom) / 2);
      const r = Math.max(Math.min(rMaxW, rMaxH), cardH*1.1);
      const cyTarget = stageH*0.30 + r;
      const cyMin = padTop + cardH/2 + r;
      const cyMax = stageH - padBottom - cardH/2 - r;
      const cy = Math.max(cyMin, Math.min(cyTarget, cyMax));
      const res=[];
      for(let i=0;i<N;i++){
        const t = i/(N-1);
        const phi = phiCenter + span/2 - t*span;
        const x = cx + r*Math.cos(phi);
        const y = cy + r*Math.sin(phi);
        res.push({left:x-cardW/2, top:y-cardH/2, rot:deg(phi)+90});
      }
      return res;
    }

    function TarotFan(){
      const stageRef=React.useRef(null);
      const {w:vw,h:vh}=useWindowSize();
      const [run,setRun]=React.useState(0);
      const [showDialog,setShowDialog]=React.useState(false);
      const [dialogFadeOut,setDialogFadeOut]=React.useState(false);
      const [showChat,setShowChat]=React.useState(false);

      const readVars = () => {
        const cs = getComputedStyle(document.documentElement);
        return { w: parseFloat(cs.getPropertyValue('--card-w')), h: parseFloat(cs.getPropertyValue('--card-h')) };
      };
      const [cardVars,setCardVars]=React.useState(readVars());
      React.useEffect(()=>{ setCardVars(readVars()); }, [vw,vh]);

      const getStage = ()=> stageRef.current?.getBoundingClientRect() || {width:1280,height:720};
      const {width:stageW,height:stageH}=getStage();
      const bp = stageW < 640 ? 'mobile' : stageW < 920 ? 'tablet' : 'desktop';
      const layout = React.useMemo(()=>computeFanLayout(stageW, stageH, cardVars.w, cardVars.h, 22, bp),[stageW, stageH, cardVars]);

      const refs=React.useRef([]);
      React.useEffect(()=>{
        refs.current.forEach((el,i)=>{
          if(!el) return;
          el.classList.remove('show');
          const {left, top, rot}=layout[i];
          el.style.left = left+'px';
          el.style.top  = top +'px';
          el.style.transform = `translateY(110vh) rotate(${rot-25}deg)`;
        });
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            refs.current.forEach((el,i)=>{
              if(!el) return;
              const {rot}=layout[i];
              setTimeout(()=>{
                el.classList.add('show');
                el.style.transform = `translateY(0) rotate(${rot}deg)`;
              }, i*160);
            });
          });
        });
      }, [layout, run]);

      React.useEffect(()=>{
        setShowDialog(false); setDialogFadeOut(false); setShowChat(false);
        const delay = (layout.length-1)*160 + 1600 + 1000;
        const t = setTimeout(()=> setShowDialog(true), delay);
        return ()=> clearTimeout(t);
      }, [layout, run]);

      React.useEffect(()=>{
        if(!showDialog) return;
        const t1 = setTimeout(()=> setDialogFadeOut(true), 2000);
        const t2 = setTimeout(()=>{ setShowDialog(false); setDialogFadeOut(false); setShowChat(true); }, 2600);
        return ()=> { clearTimeout(t1); clearTimeout(t2); };
      }, [showDialog]);

      React.useEffect(()=>{
        const handler=()=> setRun(v=>v+1);
        document.addEventListener('click', handler);
        return ()=> document.removeEventListener('click', handler);
      }, []);

      return (
        <div ref={stageRef} className={`stage ${(showDialog||showChat) ? "show-dialog show-chat" : ""}`}>
          {layout.map((pos,i)=>(
            <div key={i+'-'+run} ref={el=>refs.current[i]=el} className="card" style={{left:pos.left, top:pos.top, transform:`rotate(${pos.rot}deg)`}}>
              <CardBack/>
            </div>
          ))}
          {showDialog && (
            <div className={`soft-dialog ${dialogFadeOut ? "fade-out" : ""}`}>
              <div>Bienvenido/a al OrÃ¡culo</div>
              <div className="text">FormulÃ¡ tu pregunta y dejÃ¡ que el tarot ilumine tu camino.</div>
            </div>
          )}
          {showChat && (
            <div className="chat-wrap">
              <div className="chat-pane">
                <div className="messages" id="messages">
                  <div className="bubble bot">âœ¨ El orÃ¡culo te escucha. Â¿QuÃ© inquietud querÃ©s revelar hoy?</div>
                </div>
                <div className="input-row">
                  <textarea id="input" placeholder="EscribÃ­ tu pregunta aquÃ­..."></textarea>
                  <button onClick={()=>{
                    const ta=document.getElementById('input');
                    const box=document.getElementById('messages');
                    const txt=(ta.value||'').trim();
                    if(!txt) return;
                    const u=document.createElement('div');
                    u.className='bubble user'; u.textContent=txt; box.appendChild(u);
                    ta.value='';
                    setTimeout(()=>{ const b=document.createElement('div'); b.className='bubble bot'; b.textContent='ðŸ”® La rueda giraâ€¦ pronto habrÃ¡ seÃ±ales.'; box.appendChild(b); box.scrollTop=box.scrollHeight; }, 800);
                    box.scrollTop=box.scrollHeight;
                  }}>Enviar</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TarotFan/>);
  </script>
</body>
</html>
