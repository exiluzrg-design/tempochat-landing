<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TempoChat ‚Äî charlas privadas en 10 minutos</title>
  <meta name="description" content="Sesiones privadas de 10 minutos, sin registro, 24/7 y con memoria de conversaci√≥n. Privacidad real y foco en lo que necesit√°s ahora." />
  <style>
    :root{ --bg:#0b0b0c; --panel:#141417; --panel-2:#101013; --text:#e8e8ec; --muted:#a7a7b2; --line:#222227; --brand:#2f81f7; }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
    .wrap{ max-width:1080px; margin:0 auto; padding:24px }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:12px 0; border-bottom:1px solid var(--line) }
    .brand{ display:flex; align-items:center; gap:10px }
    .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),#7aa5ff) }

    .hero{ padding:28px 0 }
    .hero h1{ font-size:clamp(28px,4vw,44px); line-height:1.1; margin:0 0 10px }
    .hero p{ color:var(--muted); margin:0 0 18px }

    /* Setup card */
    .setup{ background:var(--panel-2); border:1px solid var(--line); border-radius:12px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .setup input{ background:#121216; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px; flex:1; min-width:200px }
    .setup .btn{ background:var(--brand); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; white-space:nowrap }

    .chat{ display:flex; flex-direction:column; height:460px; margin-top:12px }
    .chatlog{ flex:1; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px; background:var(--panel-2) }
    .msg{ max-width:80%; padding:10px 14px; border-radius:14px; margin:6px 0; line-height:1.45 }
    .user{ background:#2b2b34; margin-left:auto; border-bottom-right-radius:4px }
    .assistant{ background:#1b1b20; margin-right:auto; border-bottom-left-radius:4px }
    .system{ color:var(--muted); text-align:center; margin:4px 0 }
    .typing{ display:none; color:var(--muted); margin:6px 0 }
    .row{ display:flex; gap:8px; margin-top:10px }
    input,button{ font:inherit }
    .row input{ flex:1; background:#121216; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:10px }
    .row button{ background:var(--brand); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer }
    .error{ color:#ff7a7a; font-size:13px; margin-top:6px; display:none }
    .timer{ font-size:14px; color:var(--muted); margin:6px 0; text-align:center }

    /* Nudge minuto 9 */
    .nudge{ display:none; gap:8px; justify-content:center; margin:6px 0 }
    .ghost{ background:transparent; border:1px solid var(--line); color:var(--text) }

    /* Banner de cierre */
    .closing-banner{ position:fixed; left:0; right:0; bottom:20px; margin:0 auto; max-width:1080px; background:#1b1b20; border:1px solid var(--line); border-radius:12px; padding:10px 14px; color:var(--muted); text-align:center; display:none; box-shadow:0 8px 24px rgba(0,0,0,.3); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><strong>TempoChat</strong></div>
    </header>

    <section class="hero">
      <h1>Charlas privadas de 10 minutos</h1>
      <p>Decime tu <strong>nombre</strong> y <strong>qu√© quer√©s lograr hoy</strong>. Arrancamos con foco y un mini-plan.</p>

      <!-- SETUP: nombre + objetivo (+ √°nimo opcional) -->
      <div class="setup">
        <input id="name" placeholder="Tu nombre (ej: Nicol√°s)" />
        <input id="goal" placeholder="¬øQu√© quer√©s lograr en 10 minutos?" />
        <input id="mood" placeholder="Estado de √°nimo (opcional: ansioso, confundido‚Ä¶)" />
        <button class="btn" id="start">Empezar</button>
      </div>
    </section>

    <section>
      <div class="chat">
        <div class="chatlog" id="chatlog">
          <div class="system">Bienvenido a la demo. Ten√©s 10 minutos para conversar. Empez√° escribiendo abajo üëá</div>
        </div>
        <div class="timer" id="timer">Tiempo restante: 10:00</div>

        <!-- Nudge: opciones a los 9 minutos -->
        <div class="nudge" id="nudge">
          <button class="btn" id="addTime">Agregar 5‚Ä≤</button>
          <button class="btn ghost" id="wrapUp">Vamos cerrando</button>
        </div>

        <div class="typing" id="typing">‚è≥ escribiendo‚Ä¶</div>
        <div class="error" id="error"></div>
        <div class="row">
          <input id="msg" placeholder="Escrib√≠ ac√°‚Ä¶" />
          <button id="send">Enviar</button>
        </div>
      </div>
    </section>
  </div>

  <div id="closingBanner" class="closing-banner">Cierre en curso‚Ä¶ generando conclusi√≥n final</div>

  <script>
    // --------- elementos y estado ----------
    let currentReqId = 0;
    const $ = (id) => document.getElementById(id);
    const chatlog = $('chatlog');
    const typing = $('typing');
    const errorBox = $('error');
    const input = $('msg');
    const btn = $('send');
    const timerEl = $('timer');
    const nudge = $('nudge');
    const btnAddTime = $('addTime');
    const btnWrap = $('wrapUp');
    const closingBanner = $('closingBanner');
    const fName = $('name');
    const fGoal = $('goal');
    const fMood = $('mood');
    const btnStart = $('start');

    let sessionSeconds = 600; // 10 minutos
    let interval; let askedAtNine = false;
    let closing = false;       // evita cierres duplicados
    let retriedAfter410 = false;

    // --------- helpers UI ----------
    function fmt(t){ const m=Math.floor(t/60); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
    function updateTimer(){ timerEl.textContent = `Tiempo restante: ${fmt(sessionSeconds)}`; }
    function setTyping(on){ typing.style.display = on ? 'block' : 'none'; }
    function showError(msg){ errorBox.style.display='block'; errorBox.textContent = typeof msg==='string'? msg : JSON.stringify(msg); }
    function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }
    function addMessage(role,text){ const d=document.createElement('div'); d.className='msg '+role; d.textContent=String(text||''); chatlog.appendChild(d); chatlog.scrollTop = chatlog.scrollHeight; }
    function setClosing(on){ closing = on; closingBanner.style.display = on ? 'block' : 'none'; input.disabled = on; btn.disabled = on; nudge.style.display = 'none'; }

    // --------- sesi√≥n local ----------
    function sidGet(){ return localStorage.getItem('tempochat.sid') || ''; }
    function sidSet(v){ if(v) localStorage.setItem('tempochat.sid', v); }
    function sidClear(){ localStorage.removeItem('tempochat.sid'); }
    function safeJson(t){ try{ return JSON.parse(t); }catch{ return { raw:t }; } }

    // --------- red ----------
    async function endSessionOnServer(){
      const sid = sidGet(); if(!sid) return;
      try{ await fetch('/api/session',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ op:'end', sessionId: sid }) }); }catch{}
    }
    async function extendSession(minutes=5){
      const r = await fetch('/api/session',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ op:'extend', sessionId: sidGet(), minutes }) });
      if(!r.ok) return null; return r.json();
    }

    // --------- env√≠o a backend ---------
    async function send(text){
      const reqId = ++currentReqId; clearError(); setTyping(true);
      const controller = new AbortController(); const to = setTimeout(()=>controller.abort(), 30000);
      try{
        const res = await fetch('/api/chat',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text, sessionId: sidGet() }),
          signal: controller.signal
        });
        const raw = await res.text(); const json = safeJson(raw);

        // sesi√≥n expirada: reset y reintento √∫nico
        if(res.status === 410 && !retriedAfter410){
          retriedAfter410 = true;
          await hardResetSession();
          addMessage('system', 'Sesi√≥n renovada autom√°ticamente. Pod√©s continuar.');
          return send(text);
        }

        if(reqId===currentReqId) setTyping(false);
        if(!res.ok){ showError(json?.message || json?.error || raw); return; }

        if(json.sessionId) sidSet(json.sessionId);
        const reply = json.message || json.assistant || json.reply || json.output || raw;
        addMessage('assistant', reply);
      }catch(e){
        if(reqId===currentReqId) setTyping(false);
        showError(e?.name==='AbortError' ? 'timeout' : (e?.message||'error'));
      }finally{ clearTimeout(to); }
    }

    // --------- cierre ----------
    async function requestClose(source){
      if(closing) return;
      setClosing(true);
      try{
        if(source === 'manual'){ addMessage('user','Hagamos un cierre.'); }
        else { addMessage('assistant','‚è≥ La sesi√≥n termin√≥. Preparando un cierre autom√°tico...'); }
        const cierre = 'Gener√° un cierre breve con la conclusi√≥n principal y una reflexi√≥n de lo charlado.';
        await send(cierre);
        await endSessionOnServer();
        sidClear();
      }catch(e){ showError(e?.message||'error cierre'); }
    }

    // --------- timer (sin auto-extensi√≥n; con auto-cierre al final y tras +5) ----------
    function startTimer(){
      clearInterval(interval); updateTimer(); askedAtNine = false; retriedAfter410 = false;
      interval = setInterval(async ()=>{
        sessionSeconds = Math.max(sessionSeconds - 1, 0);
        updateTimer();

        if(sessionSeconds===60 && !askedAtNine){
          askedAtNine = true;
          nudge.style.display = 'flex';
          addMessage('assistant','Queda 1 minuto. ¬øSumamos 5 minutos o prefer√≠s cerrar con una conclusi√≥n/reflexi√≥n?');
        }

        if(sessionSeconds===0){
          clearInterval(interval);
          nudge.style.display = 'none';
          await requestClose('timeout'); // ‚Üê cierre autom√°tico, tambi√©n despu√©s de extender
        }
      },1000);
    }

    function resetUI(){
      chatlog.innerHTML = '<div class="system">Bienvenido a la demo. Ten√©s 10 minutos para conversar. Empez√° escribiendo abajo üëá</div>';
      sessionSeconds = 600; updateTimer(); setTyping(false); clearError();
      input.disabled = false; btn.disabled = false; closingBanner.style.display = 'none';
      closing = false; nudge.style.display = 'none';
    }

    async function hardResetSession(){
      await endSessionOnServer(); sidClear(); resetUI(); startTimer();
    }

    // --------- inicio con contexto (nombre + objetivo + √°nimo) ----------
    async function startWithContext(){
      const name = (fName.value||'').trim();
      const goal = (fGoal.value||'').trim();
      const mood = (fMood.value||'').trim();

      if(!name && !goal && !mood){ input.focus(); return; }

      const context = [
        'Contexto del usuario:',
        name ? `- Nombre: ${name}` : null,
        goal ? `- Objetivo de la sesi√≥n: ${goal}` : null,
        mood ? `- Estado de √°nimo: ${mood}` : null,
        '',
        'Instrucciones para la apertura:',
        name ? `- Salud√° por el nombre (‚Äú${name}‚Äù).` : '- Salud√° brevemente.',
        '- Propon√© 2 preguntas gu√≠a para avanzar.',
        '- Arm√° una mini-agenda de 3 pasos para estos 10 minutos.',
        '- Cerr√° con 1 pregunta concreta para empezar.'
      ].filter(Boolean).join('\n');

      await send(context);
      if(goal){ input.placeholder = `Ej.: ${goal} ‚Üí contame en 1 frase qu√© ser√≠a un buen resultado`; }
      input.focus();
    }

    // --------- eventos ----------
    btn.addEventListener('click', ()=>{ const v=input.value.trim(); if(!v) return; addMessage('user', v); input.value=''; send(v); });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ btn.click(); } });

    btnStart.addEventListener('click', startWithContext);
    [fName, fGoal, fMood].forEach(el => el.addEventListener('keydown', e => { if(e.key==='Enter') startWithContext(); }));

    btnAddTime.addEventListener('click', async ()=>{
      const resp = await extendSession(5);
      if(resp && resp.expiresAt){
        sessionSeconds += 5*60;      // extiende la cuenta regresiva
        nudge.style.display = 'none'; // no volvemos a mostrar nudge
        addMessage('system','Se agregaron 5 minutos. Har√© un cierre autom√°tico al finalizar.');
        // NOTA: no reponemos askedAtNine, as√≠ NO vuelve a aparecer el nudge en el +5
      }
    });

    btnWrap.addEventListener('click', async ()=>{
      nudge.style.display = 'none';
      await requestClose('manual');
    });

    // --------- arranque limpio ----------
    (async function boot(){ await hardResetSession(); fName.focus(); })();
  </script>
</body>
</html>
