// --- reemplazar estas funciones y bloques ---

function setClosing(on){
  closing = on === true;
  // banner
  closingBanner.style.display = closing ? 'block' : 'none';
  // nudge siempre oculto cuando cerramos
  if (nudge) nudge.style.display = closing ? 'none' : 'none'; // nunca lo mostramos desde ac√°
  // habilitar/deshabilitar input
  input.disabled = !!closing;
  btn.disabled = !!closing;
  // mostrar/ocultar fila
  const inputRow = document.querySelector('.row');
  if (inputRow) inputRow.style.display = closing ? 'none' : '';
}

function resetUI(){
  chatlog.innerHTML = '<div class="system">Bienvenido a la demo. Ten√©s 10 minutos para conversar. Empez√° escribiendo abajo üëá</div>';
  sessionSeconds = 600;
  updateTimer();
  setTyping(false);
  clearError();
  setClosing(false); // <‚Äî IMPORTANT√çSIMO: re-habilita input y muestra la fila
}

async function hardResetSession(){
  try { await endSessionOnServer(); } catch {}
  sidClear();
  resetUI();
  startTimer();
}

// --------- eventos (registrarlos ANTES del boot) ----------
btn.addEventListener('click', ()=>{
  const v = input.value.trim();
  if(!v) return;
  addMessage('user', v);
  input.value = '';
  send(v);
});

input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const v = input.value.trim();
    if(!v) return;
    addMessage('user', v);
    input.value = '';
    send(v);
  } else {
    scheduleAutosend();
  }
});

input.addEventListener('input', scheduleAutosend);

input.addEventListener('blur', ()=>{
  const v = input.value.trim();
  if(v){
    addMessage('user', v);
    input.value = '';
    send(v);
  }
});

// Apretar "Agregar 5‚Ä≤"
btnAddTime.addEventListener('click', async ()=>{
  // Ocultamos opciones siempre
  nudge.style.display = 'none';
  const resp = await extendSession(5);
  if(resp && resp.expiresAt){
    sessionSeconds += 5*60;
    addMessage('system','Se agregaron 5 minutos. Seguimos conversando y cierro autom√°ticamente al finalizar.');
  }
});

// Apretar "Vamos cerrando"
btnWrap.addEventListener('click', async ()=>{
  await requestClose('manual');
});

// --------- arranque (boot) ----------
(async function boot(){
  // garantizamos que NO est√© en closing
  setClosing(false);
  // timer y sesi√≥n limpia
  await hardResetSession();
  // saludo breve (sin pedir nada)
  await send(OPENING_PROMPT);
  // foco en input (y por si qued√≥ disabled, lo re-habilitamos)
  input.disabled = false;
  btn.disabled = false;
  const inputRow = document.querySelector('.row');
  if (inputRow) inputRow.style.display = '';
  input.focus();
})();
