<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TempoChat</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0b0c; color:#e7e7ea; padding:20px; }
    #typing { margin:10px 0; color:#aaa; }
    #chat p { background:#1b1b20; padding:8px 12px; border-radius:8px; margin:6px 0; }
    #error { margin-top:10px; color:#f66; }
    input, button { padding:8px 12px; border-radius:6px; border:1px solid #333; }
    button { cursor:pointer; background:#222; color:#eee; }
  </style>
</head>
<body>
  <h1>TempoChat</h1>

  <!-- Campo para escribir -->
  <input id="msg" type="text" placeholder="Escribí algo..." />
  <button onclick="sendMsg()">Enviar</button>

  <!-- Estado, respuestas y errores -->
  <div id="typing" style="display:none">⏳ escribiendo…</div>
  <div id="chat"></div>
  <div id="error"></div>

  <script>
    let currentReqId = 0;

    async function send(text) {
      const reqId = ++currentReqId;
      setTyping(true);
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, sessionId: getSessionId() }),
          signal: controller.signal
        });

        const raw = await res.text();
        const json = safeJson(raw);

        if (reqId === currentReqId) setTyping(false);
        if (!res.ok) return showError(json?.message || json?.error || raw);

        const reply = json.message || json.assistant || json.reply || json.output || raw;
        if (json.sessionId) setSessionId(json.sessionId);
        showReply(reply);
      } catch (e) {
        if (reqId === currentReqId) setTyping(false);
        showError(e?.name === 'AbortError' ? 'timeout' : e?.message || e);
      } finally {
        clearTimeout(timeout);
      }
    }

    // Helpers
    function safeJson(t){ try{ return JSON.parse(t);}catch{ return { raw:t }; } }
    function setTyping(on) { document.getElementById('typing').style.display = on ? 'block' : 'none'; }
    function showReply(text) {
      const chat = document.getElementById('chat');
      const p = document.createElement('p');
      p.textContent = text;
      chat.appendChild(p);
    }
    function showError(msg) { document.getElementById('error').textContent = msg; }
    function getSessionId() { return localStorage.getItem('tempochat.sid') || ''; }
    function setSessionId(id) { localStorage.setItem('tempochat.sid', id); }

    // Vincular al botón
    function sendMsg() {
      const input = document.getElementById('msg');
      const txt = input.value.trim();
      if (!txt) return;
      send(txt);
      input.value = '';
    }
  </script>
</body>
</html>
